name: Auto

on:
  schedule:
    - cron: "* * * * *"  # 北京时间上午06:30
  workflow_dispatch:

env:
  DIFY_TOKENS: ${{ secrets.DIFY_TOKENS }}  # API token stored in GitHub secrets
  DIFY_BASE_URL: ${{ secrets.DIFY_BASE_URL }}  # Base URL for the API
  DIFY_INPUTS: ${{ secrets.DIFY_INPUTS }}  # Any other inputs needed by the workflow

jobs:
  DifyWorkflow:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2  # Check out the code
      - uses: actions/setup-node@v2  # Set up Node.js environment
      - name: Install dependencies
        run: yarn  # Install dependencies with yarn
      - name: Debugging DIFY_INPUTS value
        run: echo "${{ secrets.DIFY_INPUTS }}"
      - name: Run Project and Make API request
        run: |
          # 转义 DIFY_INPUTS 中的特殊字符并确保其作为 JSON 正确传递
          INPUTS=$(echo "${{ secrets.DIFY_INPUTS }}" | jq -R .)  # 使用 jq 进行转义
          curl -X POST "${{ env.DIFY_BASE_URL }}/workflows/run" \
          -H "Authorization: Bearer ${{ secrets.DIFY_TOKENS }}" \
          -H "Content-Type: application/json" \
          -d '{
                "inputs": '"${INPUTS}"',
                "response_mode": "streaming",
                "user": "github"  
              }' 
          yarn workflowDify  # 运行项目工作流
